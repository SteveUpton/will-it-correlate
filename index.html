<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>AccHack14</title>
<meta charset="utf-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript" src="jquery-1.11.1.min.js"></script>
<script src="http://json-stat.org/lib/json-stat.js" type="text/javascript"></script>
<script type="text/javascript" src="canvasjs.min.js"></script>

<script type="text/javascript" src="keys.js"></script>

<style>

</style>
<style type="text/css"></style>
</head>
<body>

  <div>
    Dataset 1: <input type="text" id="dataset1-field" value="QS302EW">
    <span id="category1">Category 1:</span>
    <select id="dataset1-category"></select>
  <div>
  <br/>
  <div>
    Dataset 2: <input type="text" id="dataset2-field" value="QS601EW">
    <span id="category2">Category 2:</span>
    <select id="dataset2-category"></select>
  </div>
  <br/>

<!--  <div>
    <select>

    </select>
  </div> -->

  <div>
    <button onclick="update()">Update</button>
    <button onclick="correlate()">Do they correlate?</button>
  </div>

  <div id="chartContainer" style="width: 100%;"></div>

  <script type="text/javascript">

    areas = ["E06000001", "E06000002", "E06000003", "E06000004", "E06000005", "E06000006", "E06000007", "E06000008", "E06000009"];

    baseurl = "http://data.ons.gov.uk/ons/api/data/dataset/";

    function httpGet(theUrl) {
      var xmlHttp = null;
      xmlHttp = new XMLHttpRequest();
      xmlHttp.open( "GET", theUrl, false );
      xmlHttp.send( null );
      return xmlHttp.responseText;
    }

    function update() {
      ds1id = document.getElementById("dataset1-field").value;
      ds2id = document.getElementById("dataset2-field").value;

      var dataset1 = JSONstat(generateQueryURL(ds1id, 'K04000001'));
      var dataset2 = JSONstat(generateQueryURL(ds2id, 'K04000001'));

      populateCategoryList(1, dataset1);
      populateCategoryList(2, dataset2);
    }

    function generateQueryURL(dataset, geocode) {
      var params = {
        apikey: keys.onsapi,
        context: 'Census',
        geog: '2011WARDH',
        "dm/2011WARDH": geocode,
        totals: 'false',
        jsontype: 'json-stat'
      }
      query = $.param(params);
      url = baseurl + dataset + '.json' + '?' + query;
      return url;
    }

    function populateCategoryList(id, dataset) {
      // The dropdown we're going to change
      select = document.getElementById('dataset' + id + '-category');

      // Clear previous options
      $(select).empty();

      // Get the list of categories
      categories = dataset.Dataset(0).id;
      for (var i = categories.length - 1; i >= 0; i--) {
        if (!dataset.Dataset(0).Dimension(categories[i]).role) {
          var categoryDimension = categories[i];
        }
      };

      // Populate the dropdown with the new categories
      document.getElementById('category'+id).innerHTML = dataset.Dataset(0).Dimension(categoryDimension).label;
      options = dataset.Dataset(0).Dimension(categoryDimension).Category();
      for (var i = options.length - 1; i >= 0; i--) {
        option = document.createElement("option");
        option.text = options[i].label;
        option.id = i;
        select.add(option);
      };
    }

    function correlate() {
      ds1dropdown = document.getElementById('dataset1-category');
      ds1SelectedID = ds1dropdown.options[ ds1dropdown.selectedIndex ].id;
      ds2dropdown = document.getElementById('dataset2-category');
      ds2SelectedID = ds2dropdown.options[ ds2dropdown.selectedIndex ].id;
      var dataPoints = [];
      for (var i = areas.length - 1; i >= 0; i--) {
        dataPoint = {};
        areaDS1 = JSONstat(generateQueryURL(ds1id, areas[i]));
        areaDS2 = JSONstat(generateQueryURL(ds2id, areas[i]));
        dataPoint.x = areaDS1.Dataset( 0 ).Data( parseInt(ds1SelectedID) ).value;
        dataPoint.y = areaDS2.Dataset( 0 ).Data( parseInt(ds2SelectedID) ).value;
        dataPoints.push(dataPoint);
      };
      console.log(dataPoints);
      drawGraph(dataPoints);
    }

    function drawGraph(inputDataPoints) {
      ds1dropdown = document.getElementById('dataset1-category');
      ds2dropdown = document.getElementById('dataset2-category');
      var chart = new CanvasJS.Chart("chartContainer",
      {
        zoomEnabled: true,
        title:{
          text: document.getElementById('category1').innerHTML + ' vs ' + document.getElementById('category2').innerHTML,
          fontSize: 20
        },
        axisX: {
          title: ds1dropdown.options[ ds1dropdown.selectedIndex ].value,
          labelFontSize: 14,
          titleFontSize: 18                            
        },
        axisY:{
          title: ds2dropdown.options[ ds2dropdown.selectedIndex ].value,
          lineThickness: 2,
          labelFontSize: 14,
          titleFontSize: 18
        },

        data: [
        {        
          type: "scatter",  
            toolTipContent: "<span style='\"'color: {color};'\"'><strong>"+ds1dropdown.options[ ds1dropdown.selectedIndex ].value+": </strong></span>{x}<br/><span style='\"'color: {color};'\"'><strong>"+ds2dropdown.options[ ds2dropdown.selectedIndex ].value+": </strong></span>{y}",
          dataPoints: inputDataPoints
        }]
      });

      chart.render();

    }

  </script>

</body>
</html>